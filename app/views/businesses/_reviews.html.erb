<div class="container">

      <div class="col-lg-11">
        <div class="row">
         <% if current_user %>
            <div class="well">                
                <% if !Rating.user_rate(@business.id, current_user.id) %>
                <h4>Leave a Rate:</h4>
                <form role="form">
                    <div class="form-group">                   
                        <div id="rateUser"></div>                      
                    </div>
                    <button id="getRating" class="btn btn-primary">Submit</button>
                </form>
                <% else %>
                <h4>Change your Rate:</h4>
                  <form role="form">
                    <div class="form-group">                   
                        <div id="rateUserUpdate"></div>                      
                    </div>
                 <button id="getRatingUpdate" class="btn btn-primary">Update</button>
                  </form>
                    <script type="text/javascript">
                        $(function () {

                            $("#rateUserUpdate").rateYo({
                                rating: <%= Rating.where(business_id: @business.id, user_id: current_user.id).first.score  %>,
                            })
                                          
                          });

                            $(function () {
                                 
                                var $rateUserupdate = $("#rateUserUpdate").rateYo();
                                var $rateId = <%= Rating.where(business_id: @business.id, user_id: current_user.id).first.id %>

                                $("#getRatingUpdate").click(function () {
                                    var rating = $rateUserupdate.rateYo("rating");
                                    $.ajax({
                                        url: '/rating/'+$rateId,
                                        type: 'PATCH',
                                        data: { score: rating }
                                });                              
                            });                                 
                         });

                    </script>
                <% end %>
            </div>
        <% else %>
            <div class="well">
                <h4>You should signed in to leave a rate</h4>
            </div
        <% end %>
            <hr>

            <% @rating.each do |rate| %>
                <div class="media">
                    <a class="pull-left" href="#">
                        <% if User.find(rate.user_id).logo.blank? %>
                            <%= image_tag "noprofile1.png", width: "64", height: "64", :class => "media-object"%>
                        <% else %>
                            <%= image_tag User.find(rate.user_id).logo_url, width: "64", height: "64", :class => "media-object"%>                         
                        <% end %>
                    </a>
                    <div class="media-body">
                        <h4 class="media-heading"><%= link_to User.find(rate.user_id).email, profiles_path(rate.user_id) %>
                            <small><%= rate.created_at %></small>
                        </h4>
                        <div id="rateYo<%= rate.id %>"></div>
                    </div>
                

                <script type="text/javascript">
                    $(function () {
                     
                      $("#rateYo<%= rate.id %>").rateYo({
                        rating: <%= rate.score %>,
                        readOnly: true
                      });

                    });
                </script>
              </div>
        <% end %>


        </div>
        <!-- <div class="alert alert-info text-center" role="alert"> No reviews</div>                            -->
    </div>


    

<script type="text/javascript">
    $(function () {

        $("#rateUser").rateYo({
            rating: 0,
            precision: 2
        })
                      
    });

        $(function () {
             
            var $rateUser = $("#rateUser").rateYo();
                 
            $("#getRating").click(function () {
                 
                    /* get rating */
            var rating = $rateUser.rateYo("rating");
            $.ajax({
                url: '/rating',
                type: 'POST',
                data: { score: rating, business_id: <%= @business.id %> }
            });
          
        });
             
    });
    
</script>